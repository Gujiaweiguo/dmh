name: Coverage Gate

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  backend-coverage:
    name: Backend Coverage Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod
          cache: true
          cache-dependency-path: backend/go.sum
      - name: Run Backend Tests with Coverage
        working-directory: backend
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic
      - name: Check Backend Coverage
        working-directory: backend
        run: |
          if [ -f coverage.out ]; then
            go tool cover -func=coverage.out | awk '/total:/ {split($0,a," "); if (a[3] >= 0.76) { print "Backend coverage OK"; exit 0 } else { print "Backend coverage not enough: " a[3]; exit 1 } }'
          else
            echo "coverage.out not found"; exit 1
          fi
        shell: bash

  frontend-admin-coverage:
    name: Frontend Admin Coverage Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend-admin/package-lock.json
      - name: Install Dependencies
        working-directory: frontend-admin
        run: npm ci
      - name: Run Frontend Admin Tests with Coverage
        working-directory: frontend-admin
        run: |
          npm run test:cov 2>&1 | tee /tmp/admin-coverage.log
          # 从 vitest 表格输出中提取 All files 行的覆盖率（按 | 分隔）
          PCT=$(grep -E "All files\s*\|" /tmp/admin-coverage.log | tail -1 | awk -F'|' '{gsub(/ /,"",$2); print $2}' | tr -d '%' || true)
          if ! [[ "$PCT" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Failed to parse Frontend Admin coverage from log"
            exit 1
          fi
          echo "Frontend Admin coverage: ${PCT}%"
          echo "ADMIN_COVERAGE=$PCT" >> $GITHUB_ENV
      - name: Check Frontend Admin Coverage
        run: |
          if [ "${ADMIN_COVERAGE%.*}" -ge 70 ]; then
            echo "Frontend Admin coverage OK (${ADMIN_COVERAGE}%)"
          else
            echo "Frontend Admin coverage not enough: ${ADMIN_COVERAGE}%"
            exit 1
          fi

  frontend-h5-coverage:
    name: Frontend H5 Coverage Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend-h5/package-lock.json
      - name: Install Dependencies
        working-directory: frontend-h5
        run: npm ci
      - name: Run Frontend H5 Tests with Coverage
        working-directory: frontend-h5
        run: |
          npm run test:cov 2>&1 | tee /tmp/h5-coverage.log
          # 从 vitest 表格输出中提取 All files 行的覆盖率（按 | 分隔）
          PCT=$(grep -E "All files\s*\|" /tmp/h5-coverage.log | tail -1 | awk -F'|' '{gsub(/ /,"",$2); print $2}' | tr -d '%' || true)
          if ! [[ "$PCT" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Failed to parse Frontend H5 coverage from log"
            exit 1
          fi
          echo "Frontend H5 coverage: ${PCT}%"
          echo "H5_COVERAGE=$PCT" >> $GITHUB_ENV
      - name: Check Frontend H5 Coverage
        run: |
          if [ "${H5_COVERAGE%.*}" -ge 44 ]; then
            echo "Frontend H5 coverage OK (${H5_COVERAGE}%)"
          else
            echo "Frontend H5 coverage not enough: ${H5_COVERAGE}%"
            exit 1
          fi
