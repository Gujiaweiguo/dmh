# Change: 新增分销端（大C端）角色与多级分销系统

## 状态: ✅ 已完成

## Why

当前系统已有4种角色：
- **P端（platform_admin）**：平台管理员，已有
- **B端（brand_admin）**：品牌管理员，已有
- **c端（participant）**：普通顾客，已有，还需完善
- **C端（distributor）**：分销商/高级顾客，**缺失**

分销商（大C端）是一种高级别的顾客角色，支付订单后自动生效，具备分享推广资格并获得推广奖励。目前该角色完全缺失，需要：
1. 定义新的分销商角色（distributor）
2. 实现支付后自动成为分销商机制
3. 支持活动级别多级分销体系
4. 提供分销商专属的推广工具（二维码海报）、数据查看和提现功能

## What Changes

- **新增** `distributor` 角色定义：作为 `participant` 的高级扩展角色
- **新增** 自动成为分销商机制：用户支付订单后自动成为分销商
- **新增** 活动级别分销奖励规则：每个活动可自定义各级奖励比例
- **新增** 多级分销体系：支持一级、二级、三级分销商（最多3级）
- **新增** 分销商专属功能：
  - 生成二维码海报（活动专属海报 + 通用分销商海报）
  - 查看推广数据和奖励明细
  - 查看下级分销商列表（仅一级下级）
  - 申请提现（需平台管理员审批）
- **新增** 品牌管理员功能：
  - 管理本品牌分销商（调整级别、暂停/激活）
  - 查看本品牌分销商、顾客、奖励详情
- **新增** 平台管理员功能：
  - 查看全局分销商、奖励、提现明细（可按品牌筛选）
  - 审批分销商提现申请
- **修改** RBAC权限系统：新增 `distributor` 角色权限定义和提现权限
- **修改** H5端：在现有顾客H5基础上增加分销功能入口
- **修改** 活动管理系统：新增分销奖励规则配置

## Impact

- **affected specs**:
  - **新增**: `distributor-system`（分销商系统）
  - **修改**: `rbac-permission-system`（新增distributor角色和提现权限）
  - **修改**: `reward-system`（支持多级分销奖励计算）
  - **修改**: `campaign-management`（新增分销奖励规则配置）
- **affected code** (预估):
  - 后端：分销商自动升级逻辑、多级奖励计算、提现审批流程、海报生成
  - 前端管理端：分销商管理、提现审批、数据查看（品牌/平台双视角）
  - H5端：分销中心、海报生成、提现申请、数据统计

## Out of Scope

- 分销商独立小程序（本变更复用现有H5）
- 分销商PC后台管理端
- 自动升级机制（分销商级别需要品牌管理员手动调整）
- 分销商更换上级功能
- 复杂的团队管理功能（仅支持查看一级下级）
- 品牌管理员审批提现（提现由平台管理员审批）

## Risks

- 多级分销可能涉及合规风险（需确保不超过3级）
- 自动成为分销商可能导致质量风险（无法筛选分销商）
- 奖励计算复杂度增加，可能影响性能
- 分销商与普通顾客的权限边界需清晰定义
- 提现审批流程可能产生人工成本

## Mitigation

- 严格限制分销层级不超过3级（符合法规要求）
- 使用缓存优化奖励计算性能
- 明确权限矩阵，分销商只能访问自己的推广数据
- 品牌管理员可以暂停违规分销商，控制质量
- 平台管理员审批提现，确保资金安全
- 自动成为分销商前检查用户是否通过支付验证（已有订单记录）
