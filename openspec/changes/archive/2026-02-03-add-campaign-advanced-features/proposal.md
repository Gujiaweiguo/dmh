# Change: 添加活动高级功能

## Why

当前活动管理系统缺少关键的营销和运营功能，导致：
1. 分销员无法快速生成推广海报，降低推广效率
2. 活动无法设置支付金额和生成支付二维码，限制了商业化能力
3. 表单字段配置不够灵活，无法满足不同业务场景的需求
4. 品牌管理员无法核销订单，线下场景无法闭环

这些功能是营销活动闭环的关键环节，需要尽快补齐。

## What Changes

### 1. 一键生成海报功能
- 在活动详情页添加"生成海报"按钮
- 支持选择海报模板（预设 3-5 个模板）
- 自动生成包含活动信息、分销二维码的海报
- 支持下载和分享海报图片

### 2. 支付配置功能
- 在活动编辑页添加支付配置区域
- 支持设置订金金额和全款金额
- 自动生成微信支付二维码
- 支持配置支付回调地址
- 在活动详情页展示支付二维码

### 3. 表单字段增强
- 新增字段类型：email（邮箱）、address（地址）、textarea（多行文本）
- 为每个字段添加必填/选填配置
- 支持字段排序和删除
- 支持字段验证规则配置（如邮箱格式、地址长度等）
- 实时预览表单效果

### 4. 订单核销功能
- 为品牌管理员添加"扫码核销"入口
- 扫描订单二维码获取订单信息
- 显示订单详情（用户信息、支付状态、核销状态）
- 支持手动核销和取消核销
- 记录核销时间和操作人

## Impact

### 影响的模块
- **活动管理模块** (`specs/001-campaign-management.md`)
  - 新增海报生成功能
  - 新增支付配置功能
  - 增强表单字段配置
  
- **订单支付系统** (`specs/002-order-payment-system.md`)
  - 新增订单核销功能
  - 新增核销记录

### 数据库变更
- `campaigns` 表：新增 `payment_config`（支付配置）、`poster_templates`（海报模板）字段
- `orders` 表：新增 `verification_status`（核销状态）、`verified_at`（核销时间）、`verified_by`（核销人）字段
- 新增 `poster_templates` 表：存储海报模板配置

### API 变更
- 新增 `POST /api/v1/campaigns/:id/poster` - 生成海报
- 新增 `GET /api/v1/campaigns/:id/payment-qrcode` - 获取支付二维码
- 新增 `POST /api/v1/orders/:id/verify` - 核销订单
- 新增 `POST /api/v1/orders/:id/unverify` - 取消核销
- 新增 `GET /api/v1/orders/scan/:code` - 扫码获取订单信息

### 前端变更
- H5 端：
  - 新增海报生成页面
  - 新增扫码核销页面
  - 增强活动编辑页面（支付配置、表单字段配置）
- 管理后台：
  - 活动监控页面展示支付配置信息

### 依赖变更
- 新增依赖：`qrcode` 库（生成二维码）
- 新增依赖：`canvas` 或 `html2canvas` 库（生成海报图片）

## Breaking Changes

无破坏性变更。所有新功能都是增量添加，不影响现有功能。

## Migration Plan

1. 数据库迁移：执行 SQL 脚本添加新字段和新表
2. 后端部署：部署新的 API 接口
3. 前端部署：部署新的页面和功能
4. 功能验证：测试所有新功能
5. 用户培训：提供使用文档和视频教程

## Rollback Plan

如果出现问题，可以：
1. 回滚前端代码，隐藏新功能入口
2. 保留数据库变更（新字段允许为空，不影响现有功能）
3. 后端 API 保持兼容，不删除旧接口

## Timeline

- 第 1 周：数据库设计和后端 API 开发
- 第 2 周：前端页面开发和联调
- 第 3 周：测试和优化
- 第 4 周：上线和用户培训

## Success Metrics

- 海报生成成功率 > 95%
- 支付二维码生成时间 < 1 秒
- 订单核销响应时间 < 500ms
- 用户满意度 > 4.5/5
