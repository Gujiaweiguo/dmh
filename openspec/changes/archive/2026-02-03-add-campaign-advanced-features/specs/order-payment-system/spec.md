# 订单与支付系统 - 增量变更

## ADDED Requirements

### Requirement: 订单核销功能
系统 SHALL 提供订单核销功能，支持品牌管理员通过扫描二维码核销已支付订单，记录核销时间和操作人。

#### Scenario: 扫码获取订单信息
- **WHEN** 品牌管理员打开扫码核销页面
- **AND** 扫描订单二维码
- **THEN** 系统应在 500ms 内返回订单信息
- **AND** 显示订单详情（用户信息、支付状态、核销状态、表单数据）
- **AND** 仅显示已支付且未核销的订单

#### Scenario: 确认核销订单
- **WHEN** 品牌管理员查看订单详情
- **AND** 订单状态为已支付且未核销
- **AND** 点击"确认核销"按钮
- **THEN** 系统应更新订单核销状态为 verified
- **AND** 记录核销时间（verified_at）
- **AND** 记录核销人 ID（verified_by）
- **AND** 返回核销成功提示

#### Scenario: 核销已核销的订单
- **WHEN** 品牌管理员扫描已核销的订单二维码
- **THEN** 系统应显示订单已核销
- **AND** 显示核销时间和核销人信息
- **AND** 不允许重复核销

#### Scenario: 核销未支付的订单
- **WHEN** 品牌管理员扫描未支付的订单二维码
- **THEN** 系统应返回错误提示"订单未支付，无法核销"
- **AND** 不允许核销操作

#### Scenario: 取消核销订单
- **WHEN** 品牌管理员查看已核销的订单
- **AND** 核销时间在当天内
- **AND** 点击"取消核销"按钮
- **AND** 输入取消原因
- **THEN** 系统应更新订单核销状态为 unverified
- **AND** 清空核销时间和核销人
- **AND** 记录取消核销操作日志

#### Scenario: 取消核销超过当天的订单
- **WHEN** 品牌管理员尝试取消核销超过当天的订单
- **THEN** 系统应返回错误提示"仅支持取消当天的核销记录"
- **AND** 不允许取消核销

### Requirement: 订单核销码生成
系统 SHALL 为每个订单生成唯一的核销码，核销码应包含订单 ID、时间戳和签名，防止伪造。

#### Scenario: 创建订单时生成核销码
- **WHEN** 用户成功创建订单
- **THEN** 系统应生成唯一的核销码
- **AND** 核销码应包含订单 ID
- **AND** 核销码应包含时间戳
- **AND** 核销码应包含基于密钥的签名
- **AND** 保存核销码到 orders.verification_code 字段

#### Scenario: 验证核销码有效性
- **WHEN** 品牌管理员扫描订单二维码
- **THEN** 系统应验证核销码的签名
- **AND** 签名验证失败时返回错误"无效的核销码"
- **AND** 签名验证成功时返回订单信息

#### Scenario: 核销码有效期
- **WHEN** 订单创建超过 24 小时
- **AND** 品牌管理员扫描订单二维码
- **THEN** 系统应检查核销码有效期
- **AND** 超过有效期时返回提示"核销码已过期，请联系客服"

### Requirement: 订单核销权限控制
系统 SHALL 限制只有品牌管理员角色可以执行订单核销操作。

#### Scenario: 品牌管理员访问核销页面
- **WHEN** 品牌管理员登录系统
- **AND** 访问扫码核销页面
- **THEN** 系统应允许访问
- **AND** 显示核销功能

#### Scenario: 非品牌管理员访问核销页面
- **WHEN** 普通用户或分销员登录系统
- **AND** 尝试访问扫码核销页面
- **THEN** 系统应返回权限错误
- **AND** 提示"您没有权限访问此页面"

#### Scenario: 品牌管理员核销其他品牌的订单
- **WHEN** 品牌管理员扫描其他品牌的订单二维码
- **THEN** 系统应验证订单所属品牌
- **AND** 不匹配时返回错误"无权核销此订单"

### Requirement: 订单核销操作日志
系统 SHALL 记录所有订单核销操作，包括核销、取消核销，记录操作人、操作时间、操作 IP。

#### Scenario: 记录核销操作日志
- **WHEN** 品牌管理员成功核销订单
- **THEN** 系统应记录操作日志
- **AND** 日志应包含订单 ID、操作类型（verify）、操作人 ID、操作时间、操作 IP

#### Scenario: 记录取消核销操作日志
- **WHEN** 品牌管理员取消核销订单
- **THEN** 系统应记录操作日志
- **AND** 日志应包含订单 ID、操作类型（unverify）、操作人 ID、操作时间、取消原因

#### Scenario: 查询核销操作日志
- **WHEN** 管理员查询订单的核销历史
- **THEN** 系统应返回该订单的所有核销操作记录
- **AND** 按时间倒序排列

## MODIFIED Requirements

### Requirement: 订单创建
系统 SHALL 支持用户创建订单，包括填写表单、选择推荐人、防重复检查、生成核销码。

#### Scenario: 创建订单并生成核销码
- **WHEN** 用户在活动页面提交表单
- **AND** 填写姓名、手机号、邮箱、地址等信息
- **AND** 通过分销员链接访问（包含 referrerId）
- **THEN** 系统应验证活动有效性
- **AND** 执行防重复检查（campaign_id + phone）
- **AND** 创建订单记录（状态：pending）
- **AND** 生成唯一的核销码
- **AND** 返回订单信息和核销码

#### Scenario: 防重复报名检查
- **WHEN** 用户尝试重复报名同一活动
- **AND** 数据库中已存在该用户在该活动的订单（未删除）
- **THEN** 系统应返回错误"您已参与过该活动"
- **AND** 不创建新订单

### Requirement: 订单查询
系统 SHALL 支持按订单 ID、用户手机号、活动 ID、推荐人 ID 查询订单，返回订单详情包括核销状态。

#### Scenario: 查询订单详情包含核销信息
- **WHEN** 用户查询订单详情
- **THEN** 系统应返回订单基本信息
- **AND** 返回活动信息
- **AND** 返回表单数据
- **AND** 返回支付状态
- **AND** 返回核销状态（unverified/verified/cancelled）
- **AND** 如果已核销，返回核销时间和核销人信息

#### Scenario: 品牌管理员查询活动订单列表
- **WHEN** 品牌管理员查询某活动的订单列表
- **AND** 筛选核销状态为"已核销"
- **THEN** 系统应返回该活动下所有已核销的订单
- **AND** 包含核销时间和核销人信息
- **AND** 支持分页

## REMOVED Requirements

无删除的需求。
