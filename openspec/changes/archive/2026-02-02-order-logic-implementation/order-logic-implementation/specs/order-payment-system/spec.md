# Spec: 订单与支付系统

**变更类型**: 修改

**相关提案**: [order-logic-implementation](../changes/order-logic-implementation/proposal.md)

---

## ADDED Requirements

### Requirement: 订单创建业务逻辑

系统 SHALL 实现完整的订单创建业务逻辑，包括验证、存储和推荐人处理。

#### Scenario: 正常创建订单
- **GIVEN** 一个有效的活动（状态为 active，当前时间在活动时间范围内）
- **AND** 一个未参与该活动的用户（数据库中无重复订单）
- **AND** 用户提交了完整的表单数据（所有必填字段已填写）
- **WHEN** 用户通过 API 提交订单创建请求
- **THEN** 系统应创建订单记录
- **AND** 系统应为订单生成唯一的核销码（包含时间戳和签名）
- **AND** 系应返回订单 ID 和核销码
- **AND** 系应记录订单创建时间

#### Scenario: 活动不存在
- **GIVEN** 用户尝试创建订单
- **AND** 指定的活动 ID 在数据库中不存在
- **WHEN** 用户提交订单创建请求
- **THEN** 系统应返回 400 错误
- **AND** 错误信息应包含 "活动不存在"

#### Scenario: 活动已结束
- **GIVEN** 一个已结束的活动（状态非 active）
- **WHEN** 用户尝试创建订单
- **THEN** 系统应返回 400 错误
- **AND** 错误信息应包含 "活动已结束"

#### Scenario: 重复报名
- **GIVEN** 用户已经参与过某个活动（数据库中存在未删除的订单）
- **WHEN** 用户再次尝试参与同一活动
- **THEN** 系统应返回 400 错误
- **AND** 错误信息应包含 "您已参与过该活动"

#### Scenario: 表单验证失败
- **GIVEN** 活动要求填写手机号
- **AND** 用户提交了格式错误的手机号（如 10 位数字）
- **WHEN** 用户提交订单创建请求
- **THEN** 系统应返回 400 错误
- **AND** 错误信息应包含 "手机号格式不正确"

#### Scenario: 带推荐人创建订单
- **GIVEN** 一个有效的活动
- **AND** 用户提供了一个有效的推荐人 ID
- **WHEN** 用户通过 API 提交订单创建请求
- **THEN** 系统应创建订单记录
- **AND** 系统应在订单中记录推荐人 ID
- **AND** 系统应在稍后处理推荐奖励（异步）

---

### Requirement: 订单核销业务逻辑

系统 SHALL 完善订单核销业务逻辑，包括核销、取消核销和扫码获取订单信息。

#### Scenario: 核销订单（正常流程）
- **GIVEN** 一个待核销的订单（状态为 pending 或 unverified）
- **AND** 用户是品牌管理员或平台管理员
- **AND** 用户提供了正确的核销码
- **WHEN** 用户提交核销请求
- **THEN** 系统应验证核销码签名
- **AND** 签名验证通过后，系统应更新订单状态为 verified
- **AND** 系统应记录核销时间（verified_at）
- **AND** 系统应记录核销人 ID（verified_by）
- **AND** 系统应记录核销方式为 manual
- **AND** 系统应返回核销成功响应

#### Scenario: 核销已核销的订单
- **GIVEN** 一个已核销的订单（状态为 verified）
- **WHEN** 用户尝试核销该订单
- **THEN** 系统应返回 400 错误
- **AND** 错误信息应包含 "订单已核销"

#### Scenario: 核销码无效
- **GIVEN** 一个待核销的订单
- **AND** 用户提供了错误的核销码（签名不匹配或过期）
- **WHEN** 用户提交核销请求
- **THEN** 系统应返回 400 错误
- **AND** 错误信息应包含 "核销码无效"

#### Scenario: 权限不足
- **GIVEN** 普通用户（非品牌管理员）
- **AND** 用户尝试核销订单
- **WHEN** 用户提交核销请求
- **THEN** 系统应返回 403 错误
- **AND** 错误信息应包含 "权限不足"

#### Scenario: 取消核销订单
- **GIVEN** 一个已核销的订单（状态为 verified）
- **AND** 用户是品牌管理员或平台管理员
- **WHEN** 用户提交取消核销请求
- **THEN** 系统应更新订单状态为 unverified
- **AND** 系统应清除核销时间（verified_at）
- **AND** 系统应清除核销人 ID（verified_by）
- **AND** 系统应记录取消核销操作日志
- **AND** 系统应返回取消成功响应

#### Scenario: 扫码获取订单信息
- **GIVEN** 用户通过核销码扫码
- **AND** 系统验证核销码签名通过
- **WHEN** 用户请求订单信息
- **THEN** 系统应返回订单详细信息
- **AND** 应包含订单基本信息、活动信息、用户信息
- **AND** 应包含核销状态（verified/unverified）

---

### Requirement: 核销码生成与验证

系统 SHALL 实现安全的核销码生成和验证机制。

#### Scenario: 生成核销码
- **GIVEN** 系统创建新订单
- **WHEN** 生成核销码
- **THEN** 核销码格式应为：`{order_id}_{phone}_{timestamp}_{signature}`
- **AND** timestamp 应为 Unix 时间戳（秒级）
- **AND** signature 应为 MD5(order_id + phone + timestamp + secret_key)
- **AND** secret_key 应配置在环境变量中

#### Scenario: 验证核销码
- **GIVEN** 系统收到核销验证请求
- **AND** 输入的核销码包含时间戳
- **WHEN** 验证核销码
- **THEN** 系统应验证时间戳是否在有效期内（如 24 小时）
- **AND** 系统应验证签名是否正确
- **AND** 如果任一验证失败，系统应拒绝核销请求

---

### Requirement: 表单字段验证服务

系统 SHALL 提供完整的表单字段验证服务，支持多种字段类型和验证规则。

#### Scenario: 验证文本字段
- **GIVEN** 一个文本类型的表单字段，必填为 true
- **AND** 用户提交了非空字符串
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 文本字段为空
- **GIVEN** 一个文本类型的表单字段，必填为 true
- **AND** 用户提交了空字符串
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "字段不能为空"

#### Scenario: 验证手机号字段
- **GIVEN** 一个手机号类型的表单字段
- **AND** 用户提交了正确的手机号格式（11 位数字）
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 手机号格式错误
- **GIVEN** 一个手机号类型的表单字段
- **AND** 用户提交了错误格式的手机号（如 10 位数字）
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "手机号格式不正确"

#### Scenario: 验证邮箱字段
- **GIVEN** 一个邮箱类型的表单字段
- **AND** 用户提交了正确的邮箱格式
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 邮箱格式错误
- **GIVEN** 一个邮箱类型的表单字段
- **AND** 用户提交了错误格式的邮箱
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "邮箱格式不正确"

#### Scenario: 验证多行文本字段
- **GIVEN** 一个多行文本类型的表单字段，必填为 false
- **AND** 用户提交了任意长度的文本
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 验证地址字段
- **GIVEN** 一个地址类型的表单字段
- **AND** 用户提交了 10-200 字符的地址
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 地址太短
- **GIVEN** 一个地址类型的表单字段
- **AND** 用户提交了 5 个字符的地址
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "地址长度应在 10-200 字符之间"

#### Scenario: 验证地址太长
- **GIVEN** 一个地址类型的表单字段
- **AND** 用户提交了 250 个字符的地址
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "地址长度应在 10-200 字符之间"

#### Scenario: 验证选择字段
- **GIVEN** 一个选择类型的表单字段
- **AND** 字段配置了选项：["选项A", "选项B", "选项C"]
- **AND** 用户提交了"选项A"
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 选择值不在选项中
- **GIVEN** 一个选择类型的表单字段
- **AND** 字段配置了选项：["选项A", "选项B", "选项C"]
- **AND** 用户提交了"选项D"
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "选项值无效"

#### Scenario: 验证复选框字段
- **GIVEN** 一个复选框类型的表单字段，要求至少选择一项
- **AND** 用户选择了至少一个选项
- **WHEN** 验证该字段
- **THEN** 验证应通过

#### Scenario: 复选框未选择
- **GIVEN** 一个复选框类型的表单字段，要求至少选择一项
- **AND** 用户未选择任何选项
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "至少选择一项"

#### Scenario: 不支持的字段类型
- **GIVEN** 一个字段类型为"unsupported_type"
- **WHEN** 验证该字段
- **THEN** 验证应失败
- **AND** 错误信息应包含 "不支持的字段类型：unsupported_type"

---

### Requirement: 事务处理与数据一致性

系统 SHALL 使用数据库事务确保关键操作的原子性和数据一致性。

#### Scenario: 订单核销事务成功
- **GIVEN** 一个待核销的订单
- **AND** 用户是品牌管理员
- **AND** 核销码验证通过
- **WHEN** 用户提交核销请求
- **THEN** 系统应开启数据库事务
- **AND** 更新订单状态为 verified
- **AND** 记录核销操作日志
- **AND** 提交事务
- **AND** 所有操作在同一事务中完成
- **AND** 失败时自动回滚

#### Scenario: 订单核销事务失败并回滚
- **GIVEN** 一个待核销的订单
- **AND** 系统在更新订单状态时发生错误
- **WHEN** 错误发生
- **THEN** 系应回滚事务
- **AND** 数据库状态保持不变
- **AND** 系统应返回 500 错误
- **AND** 错误日志应记录

#### Scenario: 取消核销事务成功
- **GIVEN** 一个已核销的订单
- **AND** 用户是品牌管理员
- **WHEN** 用户提交取消核销请求
- **THEN** 系统应开启数据库事务
- **AND** 更新订单状态为 unverified
- **AND** 清除核销时间和核销人
- **AND** 记录取消核销操作日志
- **AND** 提交事务

---

## MODIFIED Requirements

### Requirement: 订单创建接口

**原有内容**: API 接口已定义，但业务逻辑未实现

**修改内容**: 完整实现订单创建业务逻辑，包括以下验证和处理步骤：

1. 验证用户身份（JWT Token）
2. 验证活动有效性（状态、时间范围）
3. 防重复检查（基于 campaign_id + phone）
4. 验证表单数据（必填字段、格式验证）
5. 生成核销码（带签名和时间戳）
6. 保存订单到数据库
7. 返回订单信息

#### Scenario: 完整订单创建流程
- **WHEN** 用户提交订单创建请求
- **THEN** 系统应验证所有必要条件
- **AND** 验证通过后创建订单
- **AND** 返回包含订单 ID 和核销码的响应

---

### Requirement: 订单核销接口

**原有内容**: API 接口已定义，但业务逻辑未完全实现

**修改内容**: 完善订单核销相关业务逻辑，增强权限验证和操作日志记录。

#### Scenario: 核销订单（增强权限验证）
- **GIVEN** 用户提交核销请求
- **WHEN** 验证权限
- **THEN** 系统应验证用户角色
- **AND** 只允许品牌管理员和平台管理员核销
- **AND** 只能核销自己品牌下的活动订单

#### Scenario: 核销操作日志记录
- **GIVEN** 订单核销操作成功
- **WHEN** 完成核销
- **THEN** 系统应记录操作日志
- **AND** 日志应包含：订单 ID、操作人、操作时间、操作类型、操作结果

---

## Notes

### 实现优先级
1. **P0**: 订单创建逻辑实现（影响所有后续功能）
2. **P0**: 表单字段验证服务（订单创建依赖）
3. **P1**: 订单核销逻辑完善（高级功能核心）
4. **P2**: 单元测试和集成测试

### 数据模型依赖
本变更依赖以下数据表：
- `orders` - 订单表
- `campaigns` - 活动表
- `campaign_form_fields` - 表单字段配置表
- `users` - 用户表
- `user_roles` - 用户角色表

### 安全注意事项
1. 核销码必须使用签名机制，防止伪造
2. 核销码应包含时间戳，设置有效期
3. 防重复检查依赖数据库唯一索引
4. 权限验证必须在业务逻辑中实现
5. 所有操作必须记录审计日志

### 性能考虑
1. 防重复查询应使用索引优化
2. 表单字段验证应在内存中完成
3. 核销码生成算法应高效（MD5）
4. 事务应尽可能短小，避免长事务
