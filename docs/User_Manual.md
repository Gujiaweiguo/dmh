# DMH 用户使用手册

## 目录

1. [快速开始](#快速开始)
2. [功能指南](#功能指南)
   * [活动管理](#活动管理)
   * [支付功能](#支付功能)
   * [订单核销](#订单核销)
3. [常见问题](#常见问题)
4. [附录](#附录)

***

## 快速开始

### 1. 系统要求

* **浏览器**: 现代浏览器（Chrome、Firefox、Edge 等）
* **网络**: 互联网连接
* **账号**: 平台管理员账号

### 2. 首次登录

1. 访问系统地址：`http://your-domain.com`
2. 点击登录按钮
3. 输入用户名和密码
4. 登录成功后进入管理后台

### 3. 导航概览

系统主要功能模块：

* 📊 **数据统计**：查看用户、订单、奖励数据统计
* 📅 **活动管理**：创建、编辑、删除活动
* 💰 **支付配置**：设置支付参数和费率
* 🎟 **订单核销**：核销用户订单
* 👥 **用户管理**：管理用户和权限
* ⚙️ **系统设置**：配置系统参数

***

## 功能指南

### 活动管理

#### 创建新活动

**步骤**：

1. 进入「活动管理」模块

2. 点击「创建活动」按钮

3. 填写活动基本信息：
   * 活动名称（必填）
   * 品牌（必填，从下拉列表选择）
   * 活动描述（选填）
   * 奖励规则（必填，单位：元）

4. 设置时间范围：
   * 开始时间：活动开始日期和时间
   * 结束时间：活动结束日期和时间
   * ⚠️ 注意：结束时间必须晚于开始时间

5. **配置表单字段**（可选）：
   * 点击「添加字段」按钮
   * 选择字段类型：
     * 文本框：用于收集名称、备注等信息
     * 手机号：收集用户手机，支持格式验证
     * 邮箱：收集邮箱地址
     * 下拉选择：提供预设选项（如性别、地区等）
     * 多行文本：收集详细反馈、备注
     * 地址：收集收货地址
   * 设置字段标签和是否必填
   * 为下拉选项添加选项值

6. **配置支付功能**（可选）：
   * 启用支付功能：开关按钮
   * 设置支付类型：
     * 订金模式：用户先付订金，活动结束后再付余款
     * 全款模式：一次性付清全款
   * 设置金额：
     * 订金金额：订金金额
     * 全款金额：全款总额
   * 配置微信支付参数（系统管理员配置）

7. 设置海报和分销（可选）：
   * 启用分销功能
   * 设置分销层级（1-3级）
   * 设置各级奖励比例

8. 点击「预览」查看活动效果

9. 确认无误后点击「创建」

**注意事项**：

* ⚠️ 活动创建后无法删除时间范围，请仔细检查
* 📝 建议先在测试环境验证活动流程
* 💰 表单字段一旦创建，用户报名数据将使用此格式

#### 编辑活动

1. 在活动列表中找到目标活动
2. 点击「编辑」按钮
3. 修改可编辑的字段（名称、描述、奖励规则、时间等）
4. 保存更改

#### 删除活动

1. 选中要删除的活动
2. 确认删除提示
3. ⚠️ 删除操作不可恢复

#### 活动状态管理

| 状态 | 说明 | 可执行操作 |
|------|------|----------|
| 草稿 | 活动未发布，可以编辑 | 编辑、删除、发布 |
| 进行中 | 活动正在运行中 | 查看数据、暂停、结束 |
| 已结束 | 活动已结束 | 查看数据、查看报名用户 |
| 已暂停 | 活动已暂停 | 编辑、恢复、删除 |

***

### 支付功能

#### 配置支付参数

**前置条件**：

1. 具备微信支付商户号
2. 获取微信支付 API 密钥
3. 配置微信支付回调地址

**配置步骤**：

1. 进入「系统设置」→「支付配置」
2. 填写微信支付信息：
   * AppID：微信开放平台应用 ID
   * MchID：微信支付商户号
   * API Key：APIv3 密钥（32字节）
   * API Key v3：用于签名的新密钥
   * 证书文件：apiclient\_cert.pem
   * 密钥文件：apiclient\_key.pem
3. 配置回调地址：
   * 支付结果通知：`https://your-domain.com/api/v1/payment/wechat/notify`
   * 退款通知：`https://your-domain.com/api/v1/payment/wechat/refund/notify`
4. 选择环境：
   * 沙箱环境：用于测试
   * 生产环境：实际运营环境
5. 保存配置

**测试支付**：

1. 创建测试活动
2. 配置极小金额进行测试
3. 使用沙箱环境测试
4. 验证支付流程正常后再配置正式环境

#### 用户支付流程

**订金模式流程**：

1. 用户打开活动页面
2. 点击「报名并支付」按钮
3. 扫描微信支付二维码
4. 在微信中支付订金（如 50 元）
5. 支付成功后显示支付成功
6. 用户获得参与资格
7. 活动期间，用户可选择继续支付全款

**全款模式流程**：

1. 用户打开活动页面
2. 扫描二维码
3. 在微信中支付全款（如 200 元）
4. 支付成功后获得参与资格

#### 支付状态跟踪

| 状态 | 说明 | 用户可见信息 |
|------|------|----------|
| unpaid | 未支付 | 显示支付二维码 |
| paid | 已支付 | 显示报名成功/继续支付按钮 |
| refunded | 已退款 | 显示退款信息 |

#### 支付回调处理

系统会自动处理微信支付回调：

* 支付成功 → 更新订单状态为已支付
* 支付失败 → 保持订单状态不变，记录错误日志
* 退款处理 → 更新订单状态和金额

**注意事项**：

* 确保回调地址可以被微信服务器访问
* 处理回调结果的幂等性（防止重复处理）
* 记录所有支付回调到日志，便于问题排查

***

### 订单核销

#### 核销员操作

**前提条件**：

1. 拥有核销员权限
2. 已登录系统
3. 手机上有二维码扫描器

**核销流程**：

1. 进入「订单核销」模块

2. 输入用户报名时提供的手机号

3. 点击「查询订单」按钮

4. 系统显示待核销订单列表：
   * 订单号
   * 用户姓名
   * 报名时间
   * 订单金额
   * 订单状态

5. 选择待核销的订单

6. 扫描用户出示的核销二维码
   * **方式 1**：使用手机摄像头扫描
   * **方式 2**：将二维码保存为图片后使用扫描工具

7. 系统自动验证核销码：
   * ✅ 签名正确 → 核销成功
   * ❌ 签名错误 → 提示「核销码无效」

8. 核销成功后：
   * 订单状态更新为「已核销」
   * 显示核销时间
   * 用户可以开始参与活动

**核销码安全特性**：

* 🛡️ 签名验证：防止伪造核销码
* 🚫 重复核销保护：同一订单只能核销一次
* ⏰ 时间限制：核销码有有效期（通常 30 分钟）
* 📋 操作审计：所有核销操作都有记录

#### 订单状态说明

| 状态 | 说明 | 用户端状态 | 下一步操作 |
|------|------|----------|----------|
| pending | 未支付 | 显示支付二维码 | 完成支付 |
| paid | 已支付，未核销 | 等待核销 | 等待核销员核销 |
| verified | 已核销 | 活动中 | 参与活动 |
| cancelled | 已取消 | 活动已结束 | - |

#### 常见核销场景

| 场景 | 处理方式 |
|------|----------|
| 二维码无法扫描 | 使用备用扫描工具，或引导用户截图后手动输入核销码 |
| 核销码格式错误 | 检查输入是否完整（4段，用下划线分隔） |
| 重复扫描同一二维码 | 提示「该订单已核销，不能重复核销」 |
| 订单不存在 | 提示「订单不存在，请确认订单号」 |

#### 核销员操作建议

✅ **最佳实践**：

1. 核销前先确认用户身份
2. 检查订单是否已支付
3. 在光线良好的环境下扫描二维码
4. 核销成功后向用户确认
5. 核销失败时友好解释原因

⚠️ **安全注意**：

* 不要将核销码泄露给第三方
* 不要在公开场合大声朗读核销码
* 发现异常订单立即上报

***

## 常见问题

### 登录相关

**问题：登录失败，提示「用户名或密码错误」**

* 检查用户名和密码是否正确
* 检查账号是否被禁用
* 检查密码是否包含特殊字符

**问题：登录后 Token 很快过期**

* 这是正常机制，过期需要重新登录
* 可以在「系统设置」中调整 Token 有效期

### 活动管理相关

**问题：无法创建活动，提示「结束时间不能早于开始时间」**

* 检查时间设置是否正确
* 确保结束时间晚于当前时间

**问题：表单字段无法保存**

* 检查字段是否设置了标签
* 检查字段类型是否与需求匹配

**问题：找不到已创建的活动**

* 尝试使用筛选条件（按名称、状态、时间范围）
* 检查是否有权限查看该活动

### 支付相关

**问题：支付二维码无法生成**

* 检查活动是否启用了支付功能
* 检查微信支付配置是否正确
* 检查网络连接是否正常

**问题：用户支付成功但订单状态未更新**

* 检查微信支付回调地址是否可访问
* 检查服务日志查看回调是否成功

**问题：支付二维码刷新失败**

* 这通常是正常的，建议用户重新扫描最新二维码
* 或手动刷新页面获取最新二维码

### 订单核销相关

**问题：核销码提示无效**

* 核销码格式错误：应包含 4 部分，用下划线分隔
* 核销码已过期：提示用户重新获取核销码
* 重复核销：提示该订单已核销

**问题：扫描二维码后无响应**

* 检查手机摄像头权限
* 检查网络连接
* 确认二维码清晰可扫描

### 技术支持

#### 如何获取帮助

1. **查看日志**
   * 在管理后台「系统设置」→「日志查看」
   * 筛选错误日志
   * 查看时间范围

2. **导出日志**
   * 选中需要导出的日志
   * 点击「导出」按钮
   * 下载日志文件进行分析

3. **联系技术支持**
   * 收集错误信息截图
   * 记录复现步骤
   * 提供用户信息和时间

#### 常见错误日志

**认证错误**：

```
[ERROR] Token验证失败: signature invalid
[ERROR] Token 已过期
[ERROR] 无效的 JWT claims
```

**数据库错误**：

```
[ERROR] 数据库连接失败: connection refused
[ERROR] 查询活动失败: record not found
```

**支付错误**：

```
[ERROR] 微信支付签名验证失败
[ERROR] 支付回调处理失败
[ERROR] 订单金额验证失败
```

**订单核销错误**：

```
[ERROR] 核销码签名验证失败
[ERROR] 订单已核销，无法重复核销
[ERROR] 核销码已过期
```

***

## 附录

### 权限说明

#### 平台管理员权限

* ✅ 所有活动的增删改查
* ✅ 所有订单的查看和核销
* ✅ 用户和权限管理
* ✅ 系统设置和配置
* ✅ 查看所有统计数据

#### 品牌管理员权限

* ✅ 所在品牌活动的增删改查
* ✅ 所在品牌订单的查看和核销
* ✅ 查看品牌数据统计
* ✅ 管理品牌下用户

#### 参与者权限

* ✅ 查看可参与的活动
* ✅ 创建报名订单
* ✅ 查看自己的订单
* ✅ 生成推广二维码

### 数据字段说明

#### Campaign（活动）字段

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| id | int64 | - | 活动唯一标识 |
| brandId | int64 | ✅ | 所属品牌 ID |
| name | string | ✅ | 活动名称 |
| description | string | ❌ | 活动描述 |
| rewardRule | float64 | ✅ | 奖励规则（金额） |
| startTime | datetime | ✅ | 活动开始时间 |
| endTime | datetime | ✅ | 活动结束时间 |
| status | string | ✅ | 活动状态 |
| formFields | json | ❌ | 表单字段配置 |
| paymentConfig | json | ❌ | 支付配置 |
| enableDistribution | bool | ❌ | 是否启用分销 |

#### Order（订单）字段

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| id | int64 | - | 订单唯一标识 |
| campaignId | int64 | ✅ | 关联的活动 ID |
| phone | string | ✅ | 用户手机号 |
| formData | json | ✅ | 报名表单数据 |
| amount | float64 | ✅ | 订单金额 |
| payStatus | string | - | 支付状态 |
| verificationStatus | string | - | 核销状态 |
| verificationCode | string | - | 核销码 |
| verifiedAt | datetime | - | 核销时间 |
| verifiedBy | int64 | - | 核销员 ID |

### 核销码格式说明

**格式**：`{orderId}_{phone}_{timestamp}_{signature}`

**组成部分**：

1. **orderId**：订单 ID（10 位数字）
2. **phone**：用户手机号（11 位）
3. **timestamp**：Unix 时间戳（10 位）
4. **signature**：HMAC-SHA1 签名（40 位十六进制）

**示例**：

```
10000113800138001_1738267320_abcd1234567890abcdef1234567890
```

**安全特性**：

* 包含时间戳，每次调用返回不同的二维码
* 签名验证防止伪造
* 二维码有效期限制
* 重复核销拒绝机制

### API 响应格式

**成功响应**：

```json
{
  "code": 200,
  "msg": "success",
  "data": { ... }
}
```

**错误响应**：

```json
{
  "code": 400,
  "msg": "具体错误信息",
  "data": null
}
```

***

## 版本更新日志

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0.0 | 2025-01-30 | 初始版本发布，包含：

* 活动管理完整功能
* 支付二维码生成和刷新
* 订单核销功能
* JWT 认证和 RBAC 权限
* 动态表单字段配置
* 核销码签名验证
* 完整的安全机制

***

*文档最后更新：2025年1月30日*
*适用版本：v1.0.0*
