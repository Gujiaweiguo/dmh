# DMH Flaky 测试策略

> 版本: Plan v1 (FRP-004)
> 变更: add-full-regression-testing
> 生成日期: 2026-02-18

---

## 1. Flaky 测试定义

### 1.1 判定标准

**Flaky 测试**是指在同一条件下结果不确定的测试用例。DMH 项目采用以下判定标准：

> **判定条件**: 同一测试在连续 3 次回归中出现至少 2 次非确定性失败

具体判定规则：

| 条件 | 说明 |
|------|------|
| 连续 3 次回归执行 | 必须是连续的回归执行记录 |
| 出现 2+ 次不一致结果 | 同一测试在不同次执行中结果不一致 |
| 排除代码变更导致 | 代码未变但测试结果不一致 |
| 记录失败模式 | 需记录具体的失败表现 |

### 1.2 常见 Flaky 模式

| 模式 | 描述 | 典型表现 |
|------|------|----------|
| 竞态条件 | 并发访问导致结果不确定 | 间歇性超时、数据不一致 |
| 环境依赖 | 依赖外部服务状态 | 网络超时、服务不可用 |
| 时序问题 | 等待时间不足或过长 | 元素未找到、状态未同步 |
| 资源竞争 | 共享资源状态污染 | 测试数据冲突、缓存问题 |
| 随机性 | 测试依赖随机数据 | UUID 冲突、随机值不满足条件 |

### 1.3 判定流程

```
测试失败
    │
    ▼
代码是否有变更？
    │
    ├─ 是 → 非 Flaky，修复代码或测试
    │
    └─ 否
        │
        ▼
    是否为首次失败？
        │
        ├─ 是 → 记录，等待下次回归
        │
        └─ 否
            │
            ▼
        检查历史记录
            │
            ▼
        连续 3 次回归中 2+ 次失败？
            │
            ├─ 是 → 标记为 Flaky，进入隔离流程
            │
            └─ 否 → 继续观察
```

---

## 2. 重试策略

### 2.1 可重试范围

**原则**: 仅环境瞬态失败可重试，断言失败不可重试。

| 失败类型 | 可重试 | 重试上限 | 说明 |
|----------|--------|----------|------|
| 环境瞬态失败（网络超时、服务不可用） | ✅ | 2 次 | 记录重试原因 |
| 断言失败 | ❌ | 0 次 | 代码/测试问题，需修复 |
| 配置错误 | ❌ | 0 次 | 需修复配置 |
| 资源耗尽（内存、磁盘） | ✅ | 1 次 | 可能是并发问题 |

### 2.2 重试执行规则

```
重试次数上限: 2 次（含首次执行共 3 次尝试）
重试间隔: 固定 30 秒
重试条件: 仅限以下错误类型
  - ECONNREFUSED / ETIMEDOUT
  - Service Unavailable (503)
  - Resource temporarily unavailable
```

### 2.3 重试记录要求

每次重试必须记录：

| 字段 | 说明 |
|------|------|
| 原始失败时间 | 首次失败的时间戳 |
| 失败类型 | 环境瞬态/断言/配置/资源 |
| 重试次数 | 实际重试次数 (1-2) |
| 最终结果 | PASS/FAIL |
| 原因标签 | timeout/network/service/resource |

### 2.4 重试判定矩阵

```
┌─────────────────────────────────────────────────────────────┐
│                      失败类型判定                            │
├─────────────────┬─────────────────┬─────────────────────────┤
│ 错误信息关键词   │ 判定类型        │ 是否允许重试             │
├─────────────────┼─────────────────┼─────────────────────────┤
│ timeout         │ 环境瞬态        │ ✅ 最多 2 次             │
│ ECONNREFUSED    │ 环境瞬态        │ ✅ 最多 2 次             │
│ ETIMEDOUT       │ 环境瞬态        │ ✅ 最多 2 次             │
│ 503             │ 环境瞬态        │ ✅ 最多 2 次             │
│ assertion       │ 断言失败        │ ❌ 不可重试              │
│ expected        │ 断言失败        │ ❌ 不可重试              │
│ config          │ 配置错误        │ ❌ 不可重试              │
│ ENOMEM          │ 资源耗尽        │ ✅ 最多 1 次             │
│ disk full       │ 资源耗尽        │ ✅ 最多 1 次             │
└─────────────────┴─────────────────┴─────────────────────────┘
```

---

## 3. 隔离机制

### 3.1 隔离触发条件

满足以下任一条件时，测试进入隔离状态：

1. **Flaky 判定触发**: 连续 3 次回归中出现 2+ 次非确定性失败
2. **手动隔离**: 经团队确认需要临时隔离的高风险测试
3. **修复中**: 已知问题正在修复，暂不计入回归判定

### 3.2 隔离后的影响

| 影响范围 | 说明 |
|----------|------|
| 回归判定 | 隔离测试不计入 FAIL，但记录 INCONCLUSIVE 状态 |
| 执行状态 | 隔离测试仍执行，但失败不阻断发布 |
| 报告展示 | 在报告中标记为「隔离中」，显示责任人信息 |

### 3.3 隔离项必备信息

每个隔离项必须包含：

| 字段 | 必填 | 说明 |
|------|------|------|
| 测试ID | ✅ | 唯一标识符，格式: FLT-NNN |
| 测试名称 | ✅ | 完整测试用例名称 |
| 隔离日期 | ✅ | 进入隔离的日期 (YYYY-MM-DD) |
| 责任人 | ✅ | GitHub 用户名 (@handle) |
| 截止时间 | ✅ | 承诺修复的最晚日期 |
| 退出标准 | ✅ | 明确的退出条件描述 |
| 状态 | ✅ | 隔离中 / 已退出 |
| 根因分析 | 推荐 | 失败原因的初步分析 |
| 关联 Issue | 推荐 | 追踪问题的 GitHub Issue |

---

## 4. 退出标准

### 4.1 退出隔离条件

测试退出隔离需**同时满足**以下条件：

| 条件 | 验证方式 |
|------|----------|
| 根因已定位并修复 | 代码变更已合并到主分支 |
| 连续 3 次回归全部通过 | 回归记录可追溯 |
| 责任人确认 | 责任人在隔离清单中更新状态 |

### 4.2 退出流程

```
测试处于隔离状态
    │
    ▼
修复代码已合并？
    │
    ├─ 否 → 继续隔离
    │
    └─ 是
        │
        ▼
    连续 3 次回归通过？
        │
        ├─ 否 → 继续隔离（可能需要重新修复）
        │
        └─ 是
            │
            ▼
        责任人确认？
            │
            ├─ 否 → 提醒责任人
            │
            └─ 是
                │
                ▼
            更新隔离清单
            - 状态 → 已退出
            - 记录退出日期
            - 移至历史清单
```

### 4.3 自动过期机制

为防止隔离项长期滞留，实施自动过期检查：

| 检查周期 | 说明 |
|----------|------|
| 每周检查 | 自动扫描超过截止时间的隔离项 |
| 逾期处理 | 标记为「逾期」，通知责任人和团队 |
| 强制退出 | 逾期 14 天后强制退出，测试重新计入回归 |

---

## 5. 隔离清单

### 5.1 当前隔离项

> 隔离清单中的测试不计入 FAIL，但仍需在发布报告中说明。

| 测试ID | 测试名称 | 隔离日期 | 责任人 | 截止时间 | 退出标准 | 状态 |
|--------|----------|----------|--------|----------|----------|------|
| (暂无) | - | - | - | - | - | - |

### 5.2 历史隔离项（已退出）

| 测试ID | 测试名称 | 隔离日期 | 退出日期 | 修复摘要 |
|--------|----------|----------|----------|----------|
| (暂无) | - | - | - | - |

### 5.3 清单维护规则

1. **新增隔离项**: 由责任人或测试团队添加，填写所有必填字段
2. **更新状态**: 责任人在退出条件满足后更新状态
3. **定期清理**: 每周检查并移除已退出的项到历史清单
4. **版本控制**: 隔离清单变更需提交到 Git，保留变更历史

---

## 6. 与回归判定的关系

### 6.1 隔离测试的处理方式

| 回归阶段 | 隔离测试处理 |
|----------|--------------|
| 执行 | 正常执行，不跳过 |
| 结果收集 | 单独标记，不计入 FAIL 总数 |
| 结论判定 | 产出 INCONCLUSIVE（含隔离说明） |
| 发布门禁 | 不阻断发布，但需人工确认 |

### 6.2 回归结论中的隔离说明

当存在隔离测试时，回归报告需包含：

```markdown
## 回归结论: PASS (含隔离项)

### 隔离测试摘要
- 隔离中测试: X 个
- 隔离测试结果: Y 通过 / Z 失败

### 隔离详情
| 测试ID | 责任人 | 截止时间 | 当次结果 |
|--------|--------|----------|----------|
| FLT-001 | @owner | 2026-03-01 | FAIL |

### 风险评估
[评估隔离测试失败对本次发布的影响]
```

### 6.3 决策矩阵

```
┌───────────────────────────────────────────────────────────────────┐
│                    隔离测试与回归结论关系                          │
├─────────────────┬─────────────────┬───────────────────────────────┤
│ 非隔离测试结果  │ 隔离测试结果    │ 回归结论                      │
├─────────────────┼─────────────────┼───────────────────────────────┤
│ 全部通过        │ 无隔离测试      │ PASS                          │
│ 全部通过        │ 隔离中，部分失败│ PASS (含隔离说明)             │
│ 全部通过        │ 隔离中，全部通过│ PASS                          │
│ 存在失败        │ -               │ FAIL                          │
│ 环境问题        │ -               │ INCONCLUSIVE                  │
└─────────────────┴─────────────────┴───────────────────────────────┘
```

---

## 7. 术语表

| 术语 | 定义 |
|------|------|
| **Flaky 测试** | 同一条件下结果不确定的测试用例 |
| **环境瞬态失败** | 由外部环境（网络、服务）导致的临时性失败 |
| **隔离** | 将 Flaky 测试暂时排除在 FAIL 判定之外的机制 |
| **退出标准** | 测试从隔离状态恢复到正常状态的条件 |
| **责任人** | 对隔离测试修复负责的团队成员 |
| **截止时间** | 承诺修复隔离测试的最晚日期 |
| **连续 3 次回归** | 不间断的 3 次全量回归执行记录 |

---

## 8. 参考资料

- **全量回归口径定义**: `docs/testing/execution/FULL_REGRESSION_DEFINITION.md` (FRP-002)
- **Delta 规格**: `openspec/changes/add-full-regression-testing/specs/system-test-execution/spec.md`
- **执行计划**: `openspec/changes/add-full-regression-testing/tasks.md` (Plan v1)

---

*此文档由 FRP-004 任务生成，定义 DMH 项目的 Flaky 测试处理策略。*
