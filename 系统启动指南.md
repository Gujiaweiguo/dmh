# DMH 数字营销中台 - 系统启动指南

## 一、快速启动

### 前提条件
- MySQL 5.7+ 或 8.0+
- Go 1.19+
- Node.js 16+
- npm 或 yarn

### 启动步骤

1. **配置数据库**
   ```bash
   # 启动 MySQL 服务
   # 根据你的系统选择不同的启动方式
   # Linux:
   sudo systemctl start mysql
   # 或
   sudo service mysql start

   # macOS:
   brew services start mysql

   # Windows:
   net start mysql
   ```

2. **执行启动脚本**
   ```bash
   cd /opt/code/DMH
   bash start.sh
   ```

3. **访问系统**
   - 后端 API: http://localhost:8888
   - 前端管理后台: http://localhost:5173
   - H5 端: http://localhost:3000

## 二、测试账号信息

### 1. 平台管理员
| 项目 | 内容 |
|------|------|
| 用户名 | `admin` |
| 密码 | `123456` |
| 权限 | 系统所有权限 |
| 功能 | 查看全局数据、审批提现、管理品牌和用户 |

**访问地址：** http://localhost:5173

**主要功能入口：**
- 仪表板：查看全局统计
- 用户管理：管理所有用户
- 品牌管理：管理所有品牌
- 活动管理：查看所有活动
- 分销管理：
  - 全局分销商查询：查看所有品牌的分销商
  - 全局奖励查询：查看所有品牌的奖励明细
  - 提现审批：审批分销商提现申请

---

### 2. 品牌管理员
| 项目 | 内容 |
|------|------|
| 用户名 | `brand_manager` |
| 密码 | `123456` |
| 权限 | 管理品牌A的业务 |
| 品牌 | 品牌A (ID: 1) |

**访问地址：** http://localhost:5173

**主要功能入口：**
- 仪表板：查看品牌数据统计
- 品牌管理：查看品牌信息
- 活动管理：
  - 创建/编辑活动时可以配置分销规则
  - 启用/禁用分销
  - 设置分销层级（1-3级）
  - 设置各级奖励比例（如：一级10%、二级5%、三级3%）
- 订单管理：查看品牌订单
- 分销管理：
  - 分销商管理：查看和管理本品牌分销商
  - 顾客列表：查看本品牌顾客
  - 奖励详情：查看本品牌奖励明细

---

### 3. 一级分销商
| 项目 | 内容 |
|------|------|
| 用户名 | `distributor1` |
| 密码 | `123456` |
| 角色 | 分销商（一级）|
| 品牌 | 品牌A |
| 余额 | ¥500.00 |
| 累计收益 | ¥500.00 |
| 下级数量 | 2人 |

**访问地址：** http://localhost:3000

**主要功能入口：**
- 个人中心 → 分销中心
- 分销中心页面：
  - 数据卡片：订单数、收益、下级数
  - 推广统计：查看推广数据和奖励明细
  - 下级列表：查看一级下级分销商
  - 提现管理：申请提现、查看提现记录
- 推广页面：
  - 活动专属海报：选择活动 → 生成海报 → 预览和下载
  - 通用分销商海报：展示所有活动 → 生成海报 → 预览和下载
  - 推广链接：获取分享链接和二维码

---

### 4. 二级分销商
| 项目 | 内容 |
|------|------|
| 用户名 | `distributor2` |
| 密码 | `123456` |
| 角色 | 分销商（二级）|
| 品牌 | 品牌A |
| 上级 | distributor1 (一级) |
| 余额 | ¥200.00 |
| 累计收益 | ¥200.00 |
| 下级数量 | 1人 |

**访问地址：** http://localhost:3000

**主要功能入口：** 同一级分销商

---

### 5. 三级分销商
| 项目 | 内容 |
|------|------|
| 用户名 | `distributor3` |
| 密码 | `123456` |
| 角色 | 分销商（三级）|
| 品牌 | 品牌A |
| 上级 | distributor2 (二级) |
| 余额 | ¥100.00 |
| 累计收益 | ¥100.00 |
| 下级数量 | 0人 |

**访问地址：** http://localhost:3000

**主要功能入口：** 同一级分销商

---

### 6. 普通用户1
| 项目 | 内容 |
|------|------|
| 用户名 | `participant1` |
| 密码 | `123456` |
| 角色 | 参与者（普通用户）|
| 品牌 | 品牌A |
| 余额 | ¥0.00 |

**访问地址：** http://localhost:3000

**主要功能：**
- 参与活动
- 下单支付（支付后自动成为分销商）
- 查看订单

---

### 7. 普通用户2
| 项目 | 内容 |
|------|------|
| 用户名 | `participant2` |
| 密码 | `123456` |
| 角色 | 参与者（普通用户）|
| 品牌 | 品牌A |
| 余额 | ¥0.00 |

**访问地址：** http://localhost:3000

**主要功能：** 同普通用户1

---

## 三、分销链结构

```
distributor1 (一级)
  ├── distributor2 (二级)
  │    └── distributor3 (三级)
  └── 待添加...
```

**说明：**
- `distributor1` 是一级分销商，有2个下级
- `distributor2` 是二级分销商，下级是 `distributor1`，有1个下级
- `distributor3` 是三级分销商，下级是 `distributor2`，暂无下级

---

## 四、测试数据详情

### 1. 提现申请状态

#### distributor1 的提现申请
| ID | 金额 | 状态 | 提现方式 | 账号 | 备注 |
|----|------|------|----------|------|------|
| 1 | ¥50.00 | 待审核 | 微信 | wx_13900000001 | 一级分销商 |
| 2 | ¥100.00 | 已通过 | 微信 | wx_13900000001 | 一级分销商 |

#### distributor2 的提现申请
| ID | 金额 | 状态 | 提现方式 | 账号 | 备注 |
|----|------|------|----------|------|------|
| 4 | ¥50.00 | 待审核 | 支付宝 | ali_13900000002 | 二级分销商 |
| 3 | ¥300.00 | 已拒绝 | 支付宝 | ali_13900000002 | 金额超过可提现余额 |

---

### 2. 订单数据

| 订单ID | 活动名称 | 订单金额 | 推荐人 | 分销路径 | 分销奖励 |
|--------|----------|----------|--------|----------|----------|
| 10 | 新年促销活动 | ¥100.00 | distributor1 | `1` | 一级分销 |
| 11 | 新年促销活动 | ¥200.00 | distributor3 | `1,2,3` | 三级分销 |
| 12 | 新年促销活动 | ¥150.00 | distributor2 | `1,2` | 二级分销 |
| 13 | 新年促销活动 | ¥80.00 | 无 | `` | 无 |

---

### 3. 分销奖励明细

#### 订单10（¥100.00，一级分销）
- **distributor1** 获得：¥10.00（10%）

#### 订单11（¥200.00，三级分销）
- **distributor1** 获得：¥20.00（10%）
- **distributor2** 获得：¥10.00（5%）
- **distributor3** 获得：¥6.00（3%）

#### 订单12（¥150.00，二级分销）
- **distributor1** 获得：¥15.00（10%）
- **distributor2** 获得：¥7.50（5%）

#### 订单13（¥80.00，无推荐）
- 无分销奖励

---

### 4. 活动分销规则配置

**活动名称：** 新年促销活动 / 分销测试活动

**分销配置：**
- 启用分销：是
- 分销层级：3级
- 奖励比例：
  - 一级：10%
  - 二级：5%
  - 三级：3%

---

## 五、系统功能测试流程

### 1. 测试自动升级为分销商
1. 使用 `participant1` 或 `participant2` 登录 H5 端
2. 参与活动并下单支付
3. 支付成功后，用户自动成为分销商

### 2. 测试分销推广流程
1. 使用 `distributor1` 登录 H5 端
2. 进入"推广"页面
3. 选择活动并生成海报或推广链接
4. 分享海报/链接给其他用户
5. 其他用户通过链接下单后，自动记录分销关系

### 3. 测试多级奖励分配
1. 用户通过 `distributor3` 的推广链接下单 ¥200
2. 系统自动分配奖励：
   - distributor1: ¥20.00
   - distributor2: ¥10.00
   - distributor3: ¥6.00
3. 在 H5 端查看奖励明细

### 4. 测试提现申请流程
1. 使用 `distributor1` 登录 H5 端
2. 进入"提现"页面
3. 输入提现金额、选择提现方式、填写账号信息
4. 提交提现申请
5. 查看提现记录

### 5. 测试提现审批流程（平台管理员）
1. 使用 `admin` 登录管理后台
2. 进入"提现审批"页面
3. 查看待审批提现列表
4. 选择提现申请：
   - 通过：填写审批备注
   - 拒绝：填写拒绝原因
5. 提交审批

### 6. 测试品牌管理员管理分销商
1. 使用 `brand_manager` 登录管理后台
2. 进入"分销商管理"页面
3. 查看本品牌分销商列表
4. 调整分销商级别
5. 暂停/激活分销商
6. 查看"顾客列表"
7. 查看"奖励详情"

### 7. 测试平台管理员查看全局数据
1. 使用 `admin` 登录管理后台
2. 进入"全局分销商"页面
3. 按品牌筛选查看分销商
4. 进入"全局奖励"页面
5. 按品牌筛选查看奖励明细
6. 进入"全局提现"页面
7. 按品牌筛选查看提现记录

---

## 六、手动启动各服务

### 1. 启动后端 API
```bash
cd /opt/code/DMH/backend/api
go run dmh.go
```
**访问地址：** http://localhost:8888

---

### 2. 启动前端管理后台
```bash
cd /opt/code/DMH/frontend-admin
npm install  # 首次运行需要安装依赖
npm run dev
```
**访问地址：** http://localhost:5173

---

### 3. 启动 H5 端
```bash
cd /opt/code/DMH/frontend-h5
npm install  # 首次运行需要安装依赖
npm start
```
**访问地址：** http://localhost:3000

---

## 七、数据库初始化

### 执行数据库脚本
```bash
# 1. 创建数据库并初始化表结构
mysql -uroot -p123456 < /opt/code/DMH/backend/scripts/init.sql

# 2. 创建分销商相关表
mysql -uroot -p123456 < /opt/code/DMH/backend/migrations/20250120_create_distributor_tables_final.sql

# 3. 导入完整测试数据
mysql -uroot -p123456 < /opt/code/DMH/backend/scripts/seed_complete_test_data.sql

# 4. 导入分销商系统测试数据
mysql -uroot -p123456 < /opt/code/DMH/backend/scripts/seed_distributor_test_data.sql
```

---

## 八、查看日志

### 后端日志
```bash
tail -f /tmp/dmh-backend.log
```

### 前端管理后台日志
```bash
tail -f /tmp/dmh-admin.log
```

### H5 端日志
```bash
tail -f /tmp/dmh-h5.log
```

---

## 九、停止系统

### 停止所有服务
```bash
# 查找进程并停止
ps aux | grep "dmh.go" | grep -v grep | awk '{print $2}' | xargs kill
ps aux | grep "vite" | grep -v grep | awk '{print $2}' | xargs kill
ps aux | grep "node.*app.js" | grep -v grep | awk '{print $2}' | xargs kill
```

---

## 十、常见问题

### 1. MySQL 连接失败
- 检查 MySQL 服务是否启动
- 检查用户名密码是否正确
- 检查数据库是否存在

### 2. 后端启动失败
- 检查数据库连接配置
- 检查端口 8888 是否被占用
- 查看后端日志：`tail -f /tmp/dmh-backend.log`

### 3. 前端启动失败
- 检查是否安装了 Node.js 和 npm
- 运行 `npm install` 安装依赖
- 检查端口 5173 或 3000 是否被占用

### 4. 无法登录
- 检查数据库中是否有对应的用户记录
- 确认密码是 `123456`
- 检查用户状态是否为 `active`

---

## 十一、联系支持

如有问题，请联系开发团队或查看项目文档。

---

**祝使用愉快！**
